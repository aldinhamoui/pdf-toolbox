<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Toolbox - Räkna, Döpa om & Slå ihop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js för läsning -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- PDF-Lib för modifiering/sammanslagning -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .drop-zone {
            transition: all 0.2s ease;
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%23CBD5E1FF' stroke-width='3' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
        }
        .drop-zone.active {
            background-color: #f0f9ff;
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%230EA5E9FF' stroke-width='3' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
            transform: scale(1.01);
        }
        .file-item { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .spinner { animation: rotate 2s linear infinite; }
        @keyframes rotate { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen font-sans flex flex-col">

    <div class="max-w-4xl mx-auto p-4 md:p-8 flex-grow w-full">
        <!-- Header -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900 mb-2 flex items-center justify-center gap-3">
                <svg class="w-10 h-10 text-brand-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v12a1 1 0 01-1 1H5a1 1 0 01-1-1V7a1 1 0 011-1h3a1 1 0 001-1V4z"></path></svg>
                PDF Toolbox
            </h1>
            <p class="text-slate-500 text-sm md:text-base">Säker lokal hantering av dina PDF-dokument.</p>
        </header>

        <!-- Stats Card -->
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col items-center justify-center transition-all hover:shadow-md">
                <span class="text-slate-400 text-xs font-medium uppercase tracking-wider">Antal Filer</span>
                <span id="totalFilesDisplay" class="text-2xl md:text-3xl font-bold text-slate-700">0</span>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col items-center justify-center transition-all hover:shadow-md">
                <span class="text-slate-400 text-xs font-medium uppercase tracking-wider">Totalt Sidor</span>
                <span id="totalPagesDisplay" class="text-2xl md:text-3xl font-bold text-brand-600">0</span>
            </div>
        </div>

        <!-- Info Box -->
        <div class="bg-blue-50 border-l-4 border-blue-400 p-5 mb-6 rounded-r-xl shadow-sm">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-6 w-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <div class="ml-4">
                    <h3 class="text-sm font-bold text-blue-800 uppercase tracking-wide">Hur du byter namn</h3>
                    <div class="mt-2 text-sm text-blue-700 space-y-2">
                        <p>1. Klicka direkt på filnamnet i listan för att skriva ett nytt namn.</p>
                        <p>2. Klicka på <span class="inline-flex items-center bg-blue-100 px-1 rounded text-blue-800"><svg class="w-3 h-3 mx-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> ladda ner</span> för att spara filen med det nya namnet.</p>
                        <p class="italic text-xs mt-2 border-t border-blue-200 pt-2">Verktyget ersätter inte dina originalfiler utan skapar nya kopior. För att ladda upp hela mappar, använd knappen "Välj mapp".</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Zone -->
        <div id="dropZone" class="drop-zone bg-white rounded-2xl p-6 md:p-10 text-center cursor-pointer mb-6 relative group hover:bg-slate-50 transition-colors">
            <input type="file" id="fileInput" class="hidden" multiple accept=".pdf">
            <input type="file" id="folderInput" class="hidden" webkitdirectory directory multiple>
            
            <div class="pointer-events-none">
                <div class="mb-4 flex justify-center">
                    <svg class="w-16 h-16 text-slate-300 group-hover:text-brand-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                </div>
                <h3 class="text-lg font-semibold text-slate-700 mb-2">Dra och släpp PDF-filer här</h3>
                <p class="text-slate-500 text-sm mb-6">Släpp filer direkt här för att börja.</p>
            </div>
            
            <div class="flex flex-wrap justify-center gap-3 relative z-10">
                <button onclick="document.getElementById('fileInput').click()" class="bg-brand-600 hover:bg-brand-700 text-white px-5 py-2.5 rounded-lg text-sm font-medium transition-all flex items-center shadow-md">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Välj filer
                </button>
                <button onclick="document.getElementById('folderInput').click()" class="bg-slate-700 hover:bg-slate-800 text-white px-5 py-2.5 rounded-lg text-sm font-medium transition-all flex items-center shadow-md">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>
                    Välj mapp
                </button>
            </div>
        </div>

        <!-- Toolbar -->
        <div id="toolbar" class="hidden flex flex-col md:flex-row justify-between items-center gap-4 mb-4 bg-brand-50 p-4 rounded-xl border border-brand-100">
            <div class="flex items-center gap-4">
                <label class="flex items-center text-sm font-medium text-slate-600 cursor-pointer">
                    <input type="checkbox" id="selectAll" class="mr-2 w-4 h-4 rounded text-brand-600 border-slate-300"> Markera alla
                </label>
                <span id="selectedCount" class="text-sm text-brand-700 font-semibold italic">0 markerade</span>
            </div>
            
            <div class="flex gap-2">
                <button onclick="mergeSelected()" id="mergeBtn" class="bg-green-600 hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center transition-colors shadow-sm" disabled>
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"></path></svg>
                    Slå ihop markerade
                </button>
                <button onclick="clearList()" class="text-red-500 hover:bg-red-50 px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    Rensa lista
                </button>
            </div>
        </div>

        <!-- File List Container -->
        <div id="fileListContainer" class="space-y-3">
            <!-- Files injected here -->
        </div>
    </div>

    <!-- Processing Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-[100] flex items-center justify-center">
        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center max-w-sm w-full mx-4 border border-slate-100">
            <div class="mb-4 flex justify-center">
                <svg class="w-12 h-12 text-brand-600 spinner" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m13 13v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">Bearbetar...</h3>
            <p id="loadingStatus" class="text-slate-500 text-sm">Vänligen vänta.</p>
        </div>
    </div>

    <footer class="py-10 text-center text-slate-400 text-xs mt-auto">
        <p class="font-bold text-slate-600 mb-1">PDF toolbox by Aldin Hamoui 2025</p>
        <p>Integritetssäkert: All bearbetning sker lokalt i din webbläsare.</p>
    </footer>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let filesData = [];
        
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const folderInput = document.getElementById('folderInput');
        const fileListContainer = document.getElementById('fileListContainer');
        const totalFilesDisplay = document.getElementById('totalFilesDisplay');
        const totalPagesDisplay = document.getElementById('totalPagesDisplay');
        const toolbar = document.getElementById('toolbar');
        const selectAll = document.getElementById('selectAll');
        const selectedCountLabel = document.getElementById('selectedCount');
        const mergeBtn = document.getElementById('mergeBtn');
        const loadingOverlay = document.getElementById('loadingOverlay');

        // Förenklad och säker Drag & Drop-hantering för enbart filer
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(n => {
            dropZone.addEventListener(n, e => {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        ['dragenter', 'dragover'].forEach(n => {
            dropZone.addEventListener(n, () => dropZone.classList.add('active'));
        });

        ['dragleave', 'drop'].forEach(n => {
            dropZone.addEventListener(n, () => dropZone.classList.remove('active'));
        });

        dropZone.addEventListener('drop', (e) => {
            const filesFound = [...e.dataTransfer.files];
            if (filesFound.length > 0) {
                handleFiles(filesFound);
            }
        });

        fileInput.addEventListener('change', e => handleFiles([...e.target.files]));
        folderInput.addEventListener('change', e => handleFiles([...e.target.files]));
        
        selectAll.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            filesData.forEach(f => f.selected = isChecked);
            const checkboxes = fileListContainer.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = isChecked);
            updateSelectionUI();
        });

        // Denna funktion används endast vid klick på "Välj mapp" för att bibehålla stabilitet
        async function getAllFilesFromEntry(entry) {
            let files = [];
            if (entry.isFile) {
                const file = await new Promise((resolve) => entry.file(resolve));
                if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
                    files.push(file);
                }
            } else if (entry.isDirectory) {
                const reader = entry.createReader();
                const entries = await new Promise(resolve => {
                    reader.readEntries(resolve, (err) => {
                        console.error("Mappläsningsfel", err);
                        resolve([]);
                    });
                });
                for (const childEntry of entries) {
                    const childFiles = await getAllFilesFromEntry(childEntry);
                    files.push(...childFiles);
                }
            }
            return files;
        }

        function handleFiles(files) {
            const pdfFiles = files.filter(f => f.name.toLowerCase().endsWith('.pdf'));
            if (pdfFiles.length > 0) {
                toolbar.classList.remove('hidden');
                processFiles(pdfFiles);
            }
            fileInput.value = ''; 
            folderInput.value = '';
        }

        async function processFiles(files) {
            for (const file of files) {
                const fileId = 'id-' + Math.random().toString(36).substr(2, 9);
                createFileRow(fileId, file.name);
                
                try {
                    const pageCount = await countPdfPages(file);
                    const fileObj = {
                        id: fileId,
                        name: file.name,
                        pages: pageCount,
                        size: file.size,
                        file: file,
                        selected: false
                    };
                    filesData.push(fileObj);
                    updateFileRowSuccess(fileId, pageCount, file.size);
                    updateTotals();
                } catch (error) {
                    updateFileRowError(fileId);
                }
            }
        }

        function countPdfPages(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const loadingTask = pdfjsLib.getDocument({ data: e.target.result });
                        const pdf = await loadingTask.promise;
                        resolve(pdf.numPages);
                    } catch (err) { reject(err); }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function createFileRow(id, name) {
            const div = document.createElement('div');
            div.id = `row-${id}`;
            div.className = 'file-item bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4 group hover:border-brand-300 transition-all';
            div.innerHTML = `
                <input type="checkbox" data-id="${id}" class="w-5 h-5 rounded border-slate-300 text-brand-600 focus:ring-brand-500 cursor-pointer">
                <div class="w-10 h-10 rounded-lg bg-red-50 flex items-center justify-center text-red-500 flex-shrink-0">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                </div>
                <div class="flex-grow min-w-0">
                    <div class="flex items-center gap-2">
                        <input type="text" value="${name}" data-id="${id}" 
                            class="name-input bg-transparent border-none p-0 font-medium text-slate-800 focus:ring-2 focus:ring-brand-100 focus:bg-slate-50 focus:outline-none w-full truncate cursor-text rounded px-1 transition-all"
                            title="Klicka för att ändra namn">
                    </div>
                    <p class="text-[10px] md:text-xs text-slate-400 mt-0.5 status-text flex items-center">
                        <svg class="w-3 h-3 mr-1 spinner" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m13 13v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        Läser in...
                    </p>
                </div>
                <div class="flex items-center gap-4 flex-shrink-0">
                    <div class="text-right hidden sm:block">
                        <span class="text-xl font-bold text-slate-300 page-count">-</span>
                        <span class="text-[10px] text-slate-400 block uppercase font-bold tracking-tight">Sidor</span>
                    </div>
                    <button onclick="downloadSingleFile('${id}')" class="p-2 text-slate-400 hover:text-brand-600 hover:bg-brand-50 rounded-lg transition-colors" title="Ladda ner med nytt namn">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    </button>
                </div>
            `;
            
            const input = div.querySelector('.name-input');
            input.addEventListener('input', (e) => {
                const file = filesData.find(f => f.id === id);
                if (file) file.name = e.target.value;
            });

            const cb = div.querySelector('input[type="checkbox"]');
            cb.addEventListener('change', (e) => {
                const file = filesData.find(f => f.id === id);
                if (file) file.selected = e.target.checked;
                updateSelectionUI();
            });

            fileListContainer.prepend(div);
        }

        function updateFileRowSuccess(id, count, size) {
            const row = document.getElementById(`row-${id}`);
            if (!row) return;
            row.querySelector('.status-text').innerHTML = formatBytes(size);
            const pCount = row.querySelector('.page-count');
            pCount.innerText = count;
            pCount.className = "text-xl font-bold text-brand-600 page-count";
        }

        function updateFileRowError(id) {
            const row = document.getElementById(`row-${id}`);
            if (row) row.querySelector('.status-text').innerHTML = `<span class="text-red-500">Kunde inte läsa PDF-filen</span>`;
        }

        function updateTotals() {
            const totalFiles = filesData.length;
            const totalPages = filesData.reduce((s, f) => s + f.pages, 0);
            animateValue(totalFilesDisplay, parseInt(totalFilesDisplay.innerText), totalFiles, 400);
            animateValue(totalPagesDisplay, parseInt(totalPagesDisplay.innerText), totalPages, 400);
        }

        function updateSelectionUI() {
            const selected = filesData.filter(f => f.selected);
            selectedCountLabel.innerText = `${selected.length} markerade`;
            mergeBtn.disabled = selected.length < 2;
            selectAll.checked = selected.length === filesData.length && filesData.length > 0;
        }

        function downloadSingleFile(id) {
            const fileObj = filesData.find(f => f.id === id);
            if (!fileObj) return;

            let fileName = fileObj.name;
            if (!fileName.toLowerCase().endsWith('.pdf')) fileName += '.pdf';

            const url = URL.createObjectURL(fileObj.file);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast(`Laddar ner: ${fileName}`, "success");
        }

        async function mergeSelected() {
            const selectedFiles = filesData.filter(f => f.selected);
            if (selectedFiles.length < 2) return;

            loadingOverlay.classList.remove('hidden');
            document.getElementById('loadingStatus').innerText = `Slår ihop ${selectedFiles.length} filer...`;

            try {
                const mergedPdf = await PDFLib.PDFDocument.create();
                
                for (const f of selectedFiles) {
                    const arrayBuffer = await f.file.arrayBuffer();
                    const donorPdf = await PDFLib.PDFDocument.load(arrayBuffer);
                    const copiedPages = await mergedPdf.copyPages(donorPdf, donorPdf.getPageIndices());
                    copiedPages.forEach(page => mergedPdf.addPage(page));
                }

                const pdfBytes = await mergedPdf.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = "sammanslagen_toolbox.pdf";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showToast("Filer sammanslagna!", "success");
            } catch (err) {
                console.error(err);
                showToast("Kunde inte slå ihop filerna.", "error");
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        function clearList() {
            fileListContainer.innerHTML = '';
            filesData = [];
            updateTotals();
            updateSelectionUI();
            toolbar.classList.add('hidden');
        }

        function formatBytes(b) {
            if (b === 0) return '0 B';
            const k = 1024, i = Math.floor(Math.log(b) / Math.log(k));
            return parseFloat((b / Math.pow(k, i)).toFixed(1)) + ' ' + ['B', 'KB', 'MB', 'GB'][i];
        }

        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        function showToast(msg, type) {
            const toast = document.createElement('div');
            const bg = type === 'error' ? 'bg-red-600' : 'bg-slate-800';
            toast.className = `fixed bottom-6 left-1/2 -translate-x-1/2 ${bg} text-white px-6 py-3 rounded-xl shadow-2xl z-[200] transition-all duration-300 translate-y-20 opacity-0 text-sm font-medium`;
            toast.innerText = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.remove('translate-y-20', 'opacity-0'), 10);
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>

</html>
